TEMPLATE_HOST = ENV.fetch('TEMPLATE_HOST', 'https://raw.github.com/thegarage/thegarage-template')
TEMPLATE_BRANCH = ENV.fetch('TEMPLATE_BRANCH', 'master')

# helper method to wrap a chunk of code
# with consistent output + a git commit message
def step(message)
  header = '#' * 80
  puts "\n\n"
  puts header
  puts message + '...'
  puts header
  yield
end

# shortcut method to delete existing file
# and replace with new contents
def replace_file(filename, data)
  remove_file filename
  create_file filename, data
end

# helper method to run a command and ensure success
# by default the thor run command does *not* exit
# the process when the command fails
def run_command(command, options = {})
  status = run(command, options)
  fail "#{command} failed" unless status
end

# shortcut method to add a gem to the
# gemfile/.lock/cache, and install it
def install_gem(gem_name, options = {})
  if options[:group]
    gem gem_name, group: options[:group]
  else
    gem gem_name
  end
  run_command "gem install #{gem_name}"
  run_command 'bundle install --local'
end

# download remote file from remote repo and save to local path
def get_file(path)
  resource = File.join(TEMPLATE_HOST, TEMPLATE_BRANCH, 'files', path)
  puts "Downloading resource: #{resource}"
  get resource, path
end

# Asking for sensitive information to be used later.
newrelic_key = ask("What is your NewRelic license key(enter nothing if you don't have one)?")

honeybadger_api_key = ask("What is your Honeybadger API key(enter nothing if you don't have one)?")

travis_campfire_config = if yes?("Do you want TravisCI Campfire Notifications?")
  travis_campfire_subdomain = ask("What's your Campfire subdomain?")
  travis_campfire_api_key = ask("What is your API key?")
  travis_campfire_room_id = ask("What is your Campfire room ID(not the name)?")
  <<-EOS.strip_heredoc
    notifications:
      campfire: #{travis_campfire_subdomain}:#{travis_campfire_api_key}@#{travis_campfire_room_id}
      on_success: change
      on_failure: always
  EOS
else
  nil
end

gitignore = <<-EOS
# See http://help.github.com/ignore-files/ for more about ignoring files.
#
# If you find yourself ignoring temporary files generated by your text editor
# or operating system, you probably want to add a global ignore instead:
#   git config --global core.excludesfile '~/.gitignore_global'

# Ignore bundler config.
/.bundle

# Ignore all logfiles and tempfiles.
/log/*.log
/tmp

# OSX files
.DS_Store

EOS

step 'Setup initial project Gemfile' do
  replace_file 'Gemfile', ''
  add_source "https://rubygems.org"
  insert_into_file 'Gemfile', "ruby '2.0.0'", after: "source .*\n"

  gem 'rails', '~> 4.0.1'
  gem 'jquery-rails'
  gem 'sass-rails', '~> 4.0.0'
  gem 'uglifier', '>= 1.3.0'
  gem 'haml', '~> 4.0.3'
  gem 'rails-console-tweaks'
  gem 'pg'
  gem 'pry-rails'
  gem 'dotenv-rails'
  gem 'thegarage-gitx', group: [:development, :test]
  run_command 'bundle package'

  get_file '.env'
  get_file '.ruby-version'
  replace_file '.gitignore', gitignore
end

step 'Setup Rakefile default_tasks' do
  append_to_file 'Rakefile', "\n\ndefault_tasks = []\n\ntask default: default_tasks\n"
end

step 'Remove turbolinks support by default' do
  gsub_file 'app/assets/javascripts/application.js', %r{^//= require turbolinks$.}m, ''
end

additional_application_settings = <<-EOS
# configure asset hosts for controllers + mailers
    asset_host = "\#{ENV['DEFAULT_URL_PROTOCOL']}://\#{ENV['DEFAULT_URL_HOST']}"
    config.action_controller.asset_host = asset_host
    config.action_mailer.asset_host = asset_host

    # configure url helpers to use the options from env
    default_url_options = {
      host: ENV['DEFAULT_URL_HOST'],
      protocol: ENV['DEFAULT_URL_PROTOCOL']
    }
    #{app_name.camelize}::Application.routes.default_url_options = default_url_options
    config.action_mailer.default_url_options = default_url_options

    # use SSL, use Strict-Transport-Security, and use secure cookies
    config.force_ssl = (ENV['DEFAULT_URL_PROTOCOL'] == 'https')
EOS

step 'Configure application route builders' do
  environment additional_application_settings
end

step 'Configure application default timezone' do
  environment "config.time_zone = 'Central Time (US & Canada)'"
end

step 'Add lib/autoloaded to autoload_paths' do
  create_file 'lib/autoloaded/.gitkeep', ''
  environment "config.autoload_paths << config.root.join('lib', 'autoloaded')"
end

bundler_groups_applicationrb = <<-EOS

# Delay requiring debug group until dotenv-rails has been required
# which loads the necessary ENV variables
Bundler.require(:debug) if %w{ development test }.include?(Rails.env) && ENV['BUNDLER_INCLUDE_DEBUG_GROUP'] == 'true'
EOS

env_bundler_include_debug_group = <<-EOS
# enable debug gems in development/test mode
BUNDLER_INCLUDE_DEBUG_GROUP=true

EOS
step 'Add debug Bundler group' do
  install_gem 'pry-remote', group: :debug

  append_to_file '.env', env_bundler_include_debug_group
  insert_into_file 'config/application.rb', bundler_groups_applicationrb, after: /Bundler\.require.*\n/
end

step 'Disable config.assets.debug in development environment' do
  comment_lines 'config/environments/development.rb', /config.assets.debug = true/
end

# TODO: erb
step 'Add staging environment' do
  get_file 'config/environments/staging.rb'
end

vagrant_gitignore = <<-EOS
# vagrant files
boxes/*
.vagrant
EOS

databaseyml = <<-EOS
default: &default
  adapter: postgresql
  host: localhost
  username: 'postgres'

development:
  <<: *default
  database: #{app_name.parameterize}-dev

# Warning: The database defined as "test" will be erased and
# re-generated from your development database when you run "rake".
# Do not set this db to the same as development or production.
test: &test
  <<: *default
  database: #{app_name.parameterize}-test

staging:
  <<: *default
  database: #{app_name.parameterize}-stage

production:
  <<: *default
  database: #{app_name.parameterize}-prod

EOS

step 'Setup Vagrant Virtual Machine' do
  get_file 'Vagrantfile'
  append_to_file '.gitignore', vagrant_gitignore

  get_file 'Berksfile'
  replace_file 'config/database.yml', databaseyml
  get_file 'chef/node.json'
  get_file 'bin/vm_rails_setup'
  chmod 'bin/vm_rails_setup', 0755

  create_file 'chef/roles/.gitkeep', ''
  create_file 'chef/data_bags/.gitkeep', ''
end

env_appserver_port = <<-EOS
# options for appserver
PORT=3000

EOS
step 'Adding Puma as default appserver' do
  install_gem 'foreman', group: :development
  install_gem 'puma'
  get_file 'bin/restart'
  chmod 'bin/restart', 0755
  get_file 'Procfile'

  append_to_file '.env', env_appserver_port
end

rspec_config_generators =  <<-EOS
config.generators do |g|
      g.view_specs false
      g.stylesheets = false
      g.javascripts = false
      g.helper = false
    end
EOS
rspec_base_config = <<-EOS

  config.treat_symbols_as_metadata_keys_with_true_values = true
  config.filter_run focus: true
  config.run_all_when_everything_filtered = true
EOS
rspec_extra_config = <<-EOS

  # enable controller tests to render views
  config.render_views

  # disable foo.should == bar syntax
  config.expect_with :rspec do |c|
    c.syntax = :expect
  end

EOS

step 'Add Rspec' do
  remove_dir 'test/' unless ARGV.include?("-T")
  install_gem 'rspec-rails', group: [:development, :test]
  generate 'rspec:install'
  insert_into_file 'Rakefile', "default_tasks << :spec\n\n", before: "task default: default_tasks"
  environment rspec_config_generators
  insert_into_file 'spec/spec_helper.rb', rspec_base_config, after: /RSpec.configure do .*\n/i
  insert_into_file 'spec/spec_helper.rb', rspec_extra_config, after: /RSpec.configure do .*\n/i
  comment_lines 'spec/spec_helper.rb', /config.fixture_path.*/

  install_gem 'shoulda-matchers', group: :test

  install_gem 'factory_girl_rails', group: [:development, :test]
  install_gem 'factory_girl_rspec', group: :test
end

simplecov = <<-EOS
require 'simplecov'
SimpleCov.minimum_coverage 95
SimpleCov.start 'rails'
EOS
simplecov_gitignore = <<-EOS
# Simplecov files
coverage
EOS
step 'Add simplecov gem' do
  install_gem 'simplecov', require: false, group: :test
  prepend_to_file 'spec/spec_helper.rb', simplecov
  append_to_file '.gitignore', simplecov_gitignore
end

webrat_matcher_setup = <<-EOS
  # include extensions into rspec suite
  config.include Webrat::Matchers
EOS
step 'Add Webrat gem' do
  install_gem 'webrat', group: :test
  insert_into_file 'spec/spec_helper.rb', "require 'webrat'\n", after: "require 'rspec/autorun'\n"
  insert_into_file 'spec/spec_helper.rb', webrat_matcher_setup, after: "c.syntax = :expect\n  end\n\n"
end

step 'Add should_not gem' do
  install_gem 'should_not', group: :test
  insert_into_file 'spec/spec_helper.rb', "require 'should_not/rspec'\n", after: "require 'rspec/autorun'\n"
end

step 'Add webmock gem' do
  install_gem 'webmock', group: :test
  insert_into_file 'spec/spec_helper.rb', "require 'webmock/rspec'\n", after: "require 'rspec/autorun'\n"
end

vcr_setup = <<-EOS

VCR.configure do |c|
  c.cassette_library_dir = 'spec/fixtures/vcr_cassettes'
  c.hook_into :webmock
end
EOS
step 'Add vcr gem' do
  install_gem 'vcr', group: :test
  insert_into_file 'spec/spec_helper.rb', "require 'vcr'\n", after: "require 'rspec/autorun'\n"
  append_to_file 'spec/spec_helper.rb', vcr_setup
end

rubocop_rake = <<-EOS
if defined?(Rubocop)
  require 'rubocop/rake_task'
  Rubocop::RakeTask.new do |task|
    task.patterns = ['--rails']
  end
  default_tasks << :rubocop
end

EOS
step 'Add Rubocop gem' do
  install_gem 'rubocop', group: [:development, :test]
  insert_into_file 'Rakefile', rubocop_rake, before: "task default: default_tasks"
  get_file '.rubocop.yml'
end

jasmine_rake = <<-EOS
if defined?(JasmineRails)
  default_tasks << 'spec:javascript'
end

EOS
jasmine_gitignore = <<-EOS
# jasmine-rails files
spec/tmp
spec/javascripts/fixtures/generated/
EOS
step 'Add jasmine-rails gem' do
  install_gem 'jasmine-rails', group: [:development, :test]
  route "mount JasmineRails::Engine => '/specs' if defined?(JasmineRails)"
  insert_into_file 'Rakefile', jasmine_rake, before: "task default: default_tasks"
  append_to_file '.gitignore', jasmine_gitignore
  get_file 'spec/javascripts/support/jasmine.yml'
end

jshintrb_rake = <<-EOS
if defined?(Jshintrb)
  require "jshintrb/jshinttask"
  Jshintrb::JshintTask.new :jshint do |t|
    options = JSON.load(File.read('.jshintrc'))
    globals = options.delete('globals')
    ignored = File.read('.jshintignore').split.collect {|pattern| FileList[pattern].to_a }.flatten
    files = Dir.glob('**/*.js')
    t.js_files = files
    t.exclude_js_files = ignored
    t.options = options
    t.globals = globals.keys
  end
  default_tasks << :jshint
end

EOS
step 'Add jshintrb gem' do
  install_gem 'jshintrb', group: [:development, :test]
  get_file '.jshintrc'
  get_file '.jshintignore'
  insert_into_file 'Rakefile', jshintrb_rake, before: "task default: default_tasks"
end

brakeman_task = <<-EOS
namespace :brakeman do

  desc "Run Brakeman"
  task :run, :output_files do |t, args|
    files = args[:output_files].split(' ') if args[:output_files]
    puts "Checking for security vulnerabilities..."
    tracker = Brakeman.run :app_path => ".", :output_files => files, :print_report => true
    if tracker.filtered_warnings.any?
      puts "Security vulnerabilities found!"
      exit 1
    end
  end
end

EOS
step 'Add brakeman:run Rake task' do
  install_gem 'brakeman'
  insert_into_file 'Rakefile', "default_tasks << 'brakeman:run'\n\n", before: "task default: default_tasks"
  lib 'tasks/brakeman.rake', brakeman_task
end

bundler_audit_rake = <<-EOS
namespace :bundler do
  desc 'audit Bundler Gemfile for vulnerable gems'
  task :audit do
    puts 'Checking Gemfile for vulnerable gems...'
    require 'English'
    output = `bundle-audit`
    puts output
    success = !!$CHILD_STATUS.to_i
    fail "bunder:audit failed" unless success
  end
end

EOS
step 'Add bundler:audit Rake task' do
  install_gem 'bundler-audit', group: :test, require: false
  lib 'tasks/bundler_audit.rake', bundler_audit_rake
  insert_into_file 'Rakefile', "default_tasks << 'bundler:audit'\n\n", before: "task default: default_tasks"
end

bundler_outdated_rake = <<-EOS
namespace :bundler do
  desc 'Generate report of outdated gems'
  task :outdated do
    puts "Generating report of outdated gems..."
    output = `bundle outdated`
    puts output
  end
end

EOS
step 'Add bundler:outdated Rake task' do
  lib 'tasks/bundler_outdated.rake', bundler_outdated_rake
  insert_into_file 'Rakefile', "default_tasks << 'bundler:outdated'\n\n", before: "task default: default_tasks"
end

newrelic_env = <<-EOS
# newrelic license key
# https://docs.newrelic.com/docs/ruby/ruby-agent-configuration
NEW_RELIC_LICENSE_KEY=#{newrelic_key}

EOS
# TODO: erb
step 'Add NewRelic gem' do
  install_gem 'newrelic_rpm'
  install_gem 'newrelic-rake'
  append_to_file '.env', newrelic_env
  get_file 'config/newrelic.yml'
end

honeybadger_env = <<-EOS
# honey badger account info
HONEY_BADGER_API_KEY=#{honeybadger_api_key}
EOS
honeybadgerrb = <<-EOS
  custom_env_filters = %w{
    HONEY_BADGER_API_KEY
    PGBACKUPS_URL
    HEROKU_POSTGRESQL_COBALT_URL
    DATABASE_URL
}

Honeybadger.configure do |config|
  config.api_key = ENV['HONEY_BADGER_API_KEY']
  config.params_filters.concat custom_env_filters
end
EOS
step 'Add Honeybadger gem' do
  install_gem 'honeybadger'
  append_to_file '.env', honeybadger_env
  initializer 'honeybadger.rb', honeybadgerrb
end

step 'Add Heroku 12factor gem' do
  install_gem 'rails_12factor', group: :production
end

step 'Add Travis CI' do
  install_gem 'travis', group: :development
  get_file '.travis.yml'
  append_to_file '.travis.yml', travis_campfire_config if travis_campfire_config
end

step 'Add guard-rspec gem' do
  install_gem 'guard-rspec', group: :ct
  run_command 'guard init rspec'
  gsub_file 'Guardfile', /  # Capybara features specs.*\z/m, "end\n"
  run_command 'bundle binstubs guard'
end

rubocop_guardfile = <<'EOS'

guard :rubocop, all_on_start: false, cli: ['--rails'] do
  ignore(%r{db/schema\.rb})
  ignore(%r{vendor/.+\.rb})
  ignore(%r{chef/.+\.rb})
  watch(%r{.+\.rb$})
  watch(%r{(?:.+/)?\.rubocop\.yml$}) { |m| File.dirname(m[0]) }
end
EOS
step 'Add guard-rubocop gem' do
  install_gem 'guard-rubocop', group: :ct
  append_to_file 'Guardfile', rubocop_guardfile
end

step 'Add guard-jshintrb gem' do
  install_gem 'guard-jshintrb', group: :ct
  run_command 'guard init jshintrb'
end

jasmine_rails_guardfile = <<'EOS'

guard 'jasmine-rails', all_on_start: false do
  watch(%r{spec/javascripts/helpers/.+\.(js|coffee)})
  watch(%r{spec/javascripts/.+_spec\.(js\.coffee|js|coffee)$})
  watch(%r{app/assets/javascripts/(.+?)\.(js\.coffee|js|coffee)(?:\.\w+)*$}) { |m| "spec/javascripts/#{ m[1] }_spec.#{ m[2] }" }
end
EOS
step 'Add guard-jasmine-rails gem' do
  install_gem 'guard-jasmine-rails', group: :ct
  append_to_file 'Guardfile', jasmine_rails_guardfile
end

step 'Add project documentation' do
  get_file 'CONTRIBUTING.md'
  remove_file 'README.rdoc'
  get_file 'README.md'
end

step 'Generate /static controller endpoint' do
  generate 'controller Static --no_helper'
  create_file 'app/views/static/.gitkeep', ''
  route "get 'static/:action' => 'static#:action' if Rails.env.development?"
end

step 'Cleanup rubocop validations' do
  gsub_file 'config/environments/test.rb', /config.static_cache_control = "public, max-age=3600"/, "config.static_cache_control = 'public, max-age=3600'"
  gsub_file 'config/routes.rb', /\n  \n/, ''
  gsub_file 'spec/spec_helper.rb', /"/, "'"
end

require 'securerandom'
secret_key_base = SecureRandom.hex(64)

env_secret_token = <<-EOS

# secret key used by rails for generating session cookies
# see config/initializers/secret_token.rb
SECRET_KEY_BASE=#{secret_key_base}
EOS

step 'Moving secret key to .env file' do
  gsub_file 'config/initializers/secret_token.rb', / =.*/, " = ENV['SECRET_KEY_BASE']"
  append_to_file '.env', env_secret_token
end

smtp_env = <<-EOS
#SMTP settings
SMTP_PORT=1025
SMTP_SERVER=localhost
EOS
smtp_applicationrb = <<-EOS
config.action_mailer.smtp_settings = {
      port: ENV['SMTP_PORT'],
      address: ENV['SMTP_SERVER']
    }
EOS
email_spec_matcher_setup = <<-EOS
  config.include EmailSpec::Helpers
  config.include EmailSpec::Matchers
EOS
step 'Implementing full e-mail support' do
  install_gem 'valid_email'
  install_gem 'email_spec', group: :test
  install_gem 'email_preview'
  append_to_file '.env', smtp_env
  environment smtp_applicationrb
  insert_into_file 'spec/spec_helper.rb', "require 'email_spec'\n", after: "require 'rspec/autorun'\n"
  insert_into_file 'spec/spec_helper.rb', email_spec_matcher_setup, after: "# include extensions into rspec suite\n"
end

step 'Finalize initial project' do
  run_command 'bundle install --local'
  git :init
  git add: '.'
  git commit: '-a -m "Initial checkin.  Built by thegarage-template Rails Generator"'
end
